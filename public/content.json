{"meta":{"title":"Aerial Dev","subtitle":"Distributed databases and aerial arts all rolled up into one, oddly shaped...bundle","description":"Distributed databases and aerial arts all rolled up into one, oddly shaped...bundle","author":"David Gilardi","url":"https://sonicdmg.github.io"},"pages":[{"title":"About me","date":"2017-02-06T20:54:38.000Z","updated":"2017-02-10T13:37:08.000Z","comments":true,"path":"About/index.html","permalink":"https://sonicdmg.github.io/About/index.html","excerpt":"","text":"Hi there, I’m David Gilardi, a nerd, sci-fi, fantasy enthusiast who would like nothing more than to get on the Starship Enterprise (or anything remotely like it that won’t explode on its first voyage) and explore the universe. Until that happens I’ll continue playing games, building distributed database clusters, climbing up multi-story strips of fabric while calling it “art”, and “improving” every bit of my house that I can. You mentioned distributed databasesYuppers. I’m currently a Technical Evangelist at DataStax and let me tell you after 20+ years in my career coding, DBAing, building bare metal and cloud infrastructure, and managing I am a happy camper getting back into some seriously cool tech. I have a mixed-workload search/graph/Cassandra cluster using 4 Raspberry PI’s for my core Cassandra DC. You can’t get much more commodity hardware than PI’s and my cluster is humming along quite nicely. Strips of fabric?Yes! One of my favorite activities is aerial arts. Seriously, drop the gym, start climbing stuff and your body will thank you. It also might reward you with some torn, ripped, pulled tendons, ligaments, and muscles, but no matter. It’s all earned pain. I realize I don’t make it sound all that great, but after 5 years I’m still in one piece and love every moment of it (most of the time). Here is a fun example. Sorry for the potato quality, it won’t happen again. Turn up the sound and wait for the end."}],"posts":[{"title":"Ok, yea, so maybe it's been a while since I posted","slug":"Ok-yea-so-maybe-it-s-been-a-while-since-I-posted","date":"2018-01-09T15:38:20.000Z","updated":"2018-01-09T19:14:06.000Z","comments":true,"path":"2018/01/09/Ok-yea-so-maybe-it-s-been-a-while-since-I-posted/","link":"","permalink":"https://sonicdmg.github.io/2018/01/09/Ok-yea-so-maybe-it-s-been-a-while-since-I-posted/","excerpt":"So…I’ve been busy. Quite busy since the last time I posted. Let’s see, I got married, added 2 greyhounds to the family, repaired things from Hurricane Irma, been digging into all things DataStax, and I have a child on the way (due March 15th). On the DataStax and KillrVideo front I added both a graph based recommendation engine with DSE Graph and recently DSE Search capability for all video searches in the Java version. We also have SparkSQL fun coming up here soon as well. All of the application code is available for folks to really do whatever they want with it. Feel free to leave comments, issues, or make pull requests if you have something fun to add. My main goal is for KillrVideo to be useful to folks trying to figure this stuff out. Once Spark gets into the mix KillrVideo will cover the 4 horsemen of DataStax Enterprise, namely,Cassandra, Graph, Search, and Analytics.","text":"So…I’ve been busy. Quite busy since the last time I posted. Let’s see, I got married, added 2 greyhounds to the family, repaired things from Hurricane Irma, been digging into all things DataStax, and I have a child on the way (due March 15th). On the DataStax and KillrVideo front I added both a graph based recommendation engine with DSE Graph and recently DSE Search capability for all video searches in the Java version. We also have SparkSQL fun coming up here soon as well. All of the application code is available for folks to really do whatever they want with it. Feel free to leave comments, issues, or make pull requests if you have something fun to add. My main goal is for KillrVideo to be useful to folks trying to figure this stuff out. Once Spark gets into the mix KillrVideo will cover the 4 horsemen of DataStax Enterprise, namely,Cassandra, Graph, Search, and Analytics. And then……this battle station will be fully operational!!!! Mostly, except for some unfinished turbo lasers, maybe some panels, like a whole hemisphere worth, just some small items really. Sooooo much cool stuff coming!Seriously, new OpsCenter, Studio, and DSE everything updates on the way along with a child, but that last one is not part of the normal development cycle….kind of a side project. Once I can talk about some of the new changes I’ll start posting and getting things worked into code. Until then I’ll be posting about much of what I’ve been up to this last year and passing on some things I’ve learned while wrapping my tendrils around all of this NoSQL distributed database stuff. Fun for all I’m sure. ;)","categories":[{"name":"Something Else","slug":"Something-Else","permalink":"https://sonicdmg.github.io/categories/Something-Else/"}],"tags":[{"name":"datastax","slug":"datastax","permalink":"https://sonicdmg.github.io/tags/datastax/"},{"name":"killrvideo","slug":"killrvideo","permalink":"https://sonicdmg.github.io/tags/killrvideo/"}]},{"title":"Don't block your Async calls","slug":"Don-t-block-your-Async-calls","date":"2017-04-17T14:31:42.000Z","updated":"2017-04-20T19:58:33.000Z","comments":true,"path":"2017/04/17/Don-t-block-your-Async-calls/","link":"","permalink":"https://sonicdmg.github.io/2017/04/17/Don-t-block-your-Async-calls/","excerpt":"Or rather I should be saying that to myself. So, TIL (today I learned) something simple yet profound while working with asynchronous programming and the DSE java driver. Ensure that you are properly iterating through your results when making an async call. You cannot simply iterate all of your rows using a for loop or something along the lines. Ok, well, technically you can, but if you have more rows than your fetch size the DSE java driver will throw a big fat error your way letting you know you are blocking within an async call. I should point that I am still somewhat new to working with asynchronous calls (yes, someone finally pulled up the rock I was under) so for you veterans this may be knowledge already gained from async NOOB 101. By the way, here is the error the driver threw at me (thank you for doing so DSE driver peeps).","text":"Or rather I should be saying that to myself. So, TIL (today I learned) something simple yet profound while working with asynchronous programming and the DSE java driver. Ensure that you are properly iterating through your results when making an async call. You cannot simply iterate all of your rows using a for loop or something along the lines. Ok, well, technically you can, but if you have more rows than your fetch size the DSE java driver will throw a big fat error your way letting you know you are blocking within an async call. I should point that I am still somewhat new to working with asynchronous calls (yes, someone finally pulled up the rock I was under) so for you veterans this may be knowledge already gained from async NOOB 101. By the way, here is the error the driver threw at me (thank you for doing so DSE driver peeps). 123456Detected a synchronous call on an I/O thread, this can cause deadlocks or unpredictable behavior. This generally happens when a Future callback calls a synchronous Session method (execute() or prepare()), or iterates a result set past the fetch size (causing an internal synchronous fetch of the next page of results). Avoid this in your callbacks, or schedule them on a different executor. com.datastax.driver.core.AbstractSession.checkNotInEventLoop(AbstractSession.java:206) com.datastax.driver.core.ArrayBackedResultSet$MultiPage.prepareNextRow(ArrayBackedResultSet.java:310) com.datastax.driver.core.ArrayBackedResultSet$MultiPage.isExhausted(ArrayBackedResultSet.java:269) com.datastax.driver.core.ArrayBackedResultSet$1.hasNext(ArrayBackedResultSet.java:143) com.datastax.driver.mapping.Result$1.hasNext(Result.java:102... The reason is stated here. I’ll quote it just to be clear “If you consume a ResultSet in a callback, be aware that iterating the rows will trigger synchronous queries as you page through the results. To avoid this, use getAvailableWithoutFetching to limit the iteration to the current page, and fetchMoreResults to get a future to the next page”. Even though I read this before I started into this code I must have glossed over this concept the first time through as my implementation was acting very strange indeed. Let’s look at a simple example. At this point in my code I already made an aynchronous call with session.executeAsync(), created a future, and returned my results into a callback. The following examples are within my callback.In the case below I mapped my results to the UserVideos entity and now I am iterating through those results to do something with each “userVideo” object.This…DOES NOT work and will throw the error I mentioned above. Ehem, I have a utility class handle callbacks if you were wondering where that was. I wanted to keep the example nice and simple. Just know that by the time you see “.handle” we are within the callback.1234567FutureUtils.buildCompletableFuture(userVideosMapper.mapAsync(future)) .handle((userVideos, ex) -&gt; &#123; try &#123; if (userVideos != null) &#123; for (UserVideos userVideo : userVideos) &#123; \"do something with userVideo here\" &#125; It seems so simple. I returned my results and now I want to iterate over those results and do something with them, but these aren’t synchronous calls that block until complete. I need to handle them properly from an asynchronous standpoint and only grab those results that have actually been returned. The rest I will need to fetch with more asynchronous calls. Again, this is demonstrated very clearly here in the Async paging section. This…is a snippet pulled from the working code using the example given from the async page I keep referencing. Now, I see how many items I have remaining without fetching, loop through the remaining items, and break out once I have exhausted the list. You may not see in my example below, but once I “break;” I exit out and grab futures for any more items that may be left, rinse and repeat.123456789101112FutureUtils.buildCompletableFuture(userVideosMapper.mapAsync(future)) .handle((userVideos, ex) -&gt; &#123; try &#123; if (userVideos != null) &#123; int remaining = userVideos.getAvailableWithoutFetching(); for (UserVideos userVideo : userVideos) &#123; \"do something with userVideo here\" if (--remaining == 0) &#123; break; &#125; &#125; The whole point of this post was to point out a potential “gotcha” with a very simple fix when dealing with asynchronous programming and the DSE driver for Java. This one tripped me up for a moment until I realized my mistake. Now that I know better my “futures” are looking bright in deed….see my joke there….ha….haha…..ha…awkward pause. Honestly, this simple change tightend all of my async code up. No more strange artifacts","categories":[{"name":"Technical","slug":"Technical","permalink":"https://sonicdmg.github.io/categories/Technical/"}],"tags":[{"name":"TIL","slug":"TIL","permalink":"https://sonicdmg.github.io/tags/TIL/"},{"name":"async","slug":"async","permalink":"https://sonicdmg.github.io/tags/async/"},{"name":"blocking","slug":"blocking","permalink":"https://sonicdmg.github.io/tags/blocking/"},{"name":"java","slug":"java","permalink":"https://sonicdmg.github.io/tags/java/"},{"name":"killrvideo","slug":"killrvideo","permalink":"https://sonicdmg.github.io/tags/killrvideo/"}]},{"title":"Dropping in on my cluster","slug":"Dropping-in-on-my-cluster","date":"2017-02-13T16:27:17.000Z","updated":"2017-02-13T16:35:19.000Z","comments":true,"path":"2017/02/13/Dropping-in-on-my-cluster/","link":"","permalink":"https://sonicdmg.github.io/2017/02/13/Dropping-in-on-my-cluster/","excerpt":"","text":"Looks like my nodes are healthy. :)","categories":[{"name":"Aerial","slug":"Aerial","permalink":"https://sonicdmg.github.io/categories/Aerial/"}],"tags":[{"name":"datastax","slug":"datastax","permalink":"https://sonicdmg.github.io/tags/datastax/"},{"name":"opscenter","slug":"opscenter","permalink":"https://sonicdmg.github.io/tags/opscenter/"},{"name":"aerial","slug":"aerial","permalink":"https://sonicdmg.github.io/tags/aerial/"},{"name":"drop","slug":"drop","permalink":"https://sonicdmg.github.io/tags/drop/"}]},{"title":"Mixed Workload DSE Cluster with Raspberry PI's","slug":"Mixed-Workload-DSE-Cluster-with-Raspberry-PI-s","date":"2017-02-07T18:52:11.000Z","updated":"2017-02-10T21:04:38.000Z","comments":true,"path":"2017/02/07/Mixed-Workload-DSE-Cluster-with-Raspberry-PI-s/","link":"","permalink":"https://sonicdmg.github.io/2017/02/07/Mixed-Workload-DSE-Cluster-with-Raspberry-PI-s/","excerpt":"Alrighty, as I mentioned in my previous post I have a mixed-workload cluster (Cassandra, DSE search, DSE graph) using a combination of 4 Raspberry PI’s and my laptop. I had multiple things in mind when I started into this. Low cost for learning Something I can break and not cry about How low can one really go when setting up a cluster? Get some DSE OpsCenter knowledge These are Raspberry PI’s, they are just damn cool, so why not setup a cluster?!","text":"Alrighty, as I mentioned in my previous post I have a mixed-workload cluster (Cassandra, DSE search, DSE graph) using a combination of 4 Raspberry PI’s and my laptop. I had multiple things in mind when I started into this. Low cost for learning Something I can break and not cry about How low can one really go when setting up a cluster? Get some DSE OpsCenter knowledge These are Raspberry PI’s, they are just damn cool, so why not setup a cluster?! PIE? Raspberries? 3.14? PI? + = If you are not already familiar with RaspberryPI’s go take a look. These are cool little machines for very little cost. Here are the specs for the model 3, but just to summarize each node in our cluster only has 1GB of RAM and a 1.2GHz quad-core processor. This is clearly not a setup to use in your production environment. This is, however, a great way to learn and experiment. The setup4 RaspberryPI’s (wired ethernet)NOTE: These are designed to be “built up” so you will need to purchase microSD cards and the outer shells separately One 2.6GHz 8 core MacBook with 16GB RAM (wired ethernet) DataStax Enterprise Opscenter 6.0.7 using tarball installation DataStax Agent 6.0.7 using tarball installation DataStax Enterprise 5.0.5, again, using the tarball installation RAVPower 6 port USB charger with a set of USB Male A to Micro B cables. I also purchased a 4x1 HDMI switch, but you can easily run these headless if you know your way around a Linux shell. Just a quick note about the tarball installations. DSE generally supports using installers across most major platforms and for each of the various installs, but since we are using RaspberryPI’s in this case and since I used the NOOBS install to get up and going as fast as I could it just so happens that combination only works with tarball installs. Please, learn from me and don’t spend the many, many hours I did eventually figuring this out. You can, in fact, install other operating systems on RaspberryPI’s which may allow the installers to work, but you’ll have to come back and tell me about it if you give it a go. Aaaaaaand for the reveal dun dunn dunnnnnnnnn! (Yes, those are shiny, lighted cables) I may have cheated just a little bitSo, I mentioned above “mixed workload cluster with Raspberry PI’s”. This is 100% true, but also notice there is a laptop in the mix. I ended up using the laptop to house OpsCenter and my search/graph datacenter and I’m using the PI’s for my core Cassandra cluster. In my experience I don’t usually install operations tools and the like directly on production devices facing the public because they have a tendency to cause unpredicatable load. The limited RAM on the PI’s (1GB) is also a factor which I will address here in a moment. As far as the search/graph datacenter portion I simply used the laptop out of convienence because I already had a 4-node core Cassandra cluster running on the PI’s at the time and I wanted to observe the interaction between my search/graph and Cassandra datacenters in a “pure” fashion. Get this working on PI’sRaspberry PI’s are special snowflakes when it comes to making this all work. I will detail all this below, but here, for you, is the summarized list of what is needed. Disable swapsudo swapoff -a is your friend. It is also the quick and dirty way, not permanent on reboot. Take a look at the “Disable swapping” section of this post if you would like a more permanent solution. Go HeadlessThis is quite easy to do using sudo raspi-config while ssh’d into your PI and it will help free up enough memory to make things stable. Just make sure you already know your PI’s IP address or know how to find it if things go sour. Decrease RAM allocated to datastax-agent from 128MB to 64MBEdit datastax-agent-env.sh located in [your datastax-agent install dir]/conf/datastax-agent-env.sh 12345From:JVM_OPTS=\"$JVM_OPTS -Xmx128M -Djclouds.mpu.parts.magnitude=100000 -Djclouds.mpu.parts.size=16777216\"To:JVM_OPTS=\"$JVM_OPTS -Xmx64M -Djclouds.mpu.parts.magnitude=100000 -Djclouds.mpu.parts.size=16777216\" Explicitly set Java HEAP settings for Cassandra nodeEdit cassandra-env.sh located in [your DSE install dir]/resources/cassandra/conf/cassandra-env.sh. Search for “HEAP” to find and edit the lines. Notice mine are already set to the working values. These are commented out by default which will allow the script to calculate values for you, but for our PI case we cannot use the calculated values. 12MAX_HEAP_SIZE=\"200M\"HEAP_NEWSIZE=\"50M\" Store collection data on a separate clusterRemember that part about “cheating” with my OpsCenter laptop? Yup, this is part of it. I’ll give more details down below. Let’s talk about OpsCenter, agents, memory, disk speed, and mucho frustrationoThat’s kind of a long list now that I see it all typed out, but there’s a lot to consider. We have nodes with 1GB of RAM, a 32 bit os, 4 cores, and a 32GB microSD drive acting as a hard disk. This is way below the recommended values of 16-32GB of RAM, 500GB-1TB of fast disk, and 64bit with 8 cores for running Cassandra nodes, or really any database for that matter. I wasn’t really sure how well this would work, if at all, given memory contraints alone not to mention the speed of microSD’s for a database that is known to need very fast disk. OpsCenterI decided right off the bat I wanted OpsCenter in the mix. Part of this whole project was to learn and what better way than to go whole hog and see what it could do. If you use OpsCenter you must install DataStax agents on each of your nodes in order for magic to happen. That magic comes at a memory cost, not a huge one, but one that matters when only dealing with 1GB of RAM. In order to leave enough room for the Cassandra node itself to run I effectively cut this requirement in half. So far, after months of running, I have not seen an issue running agents at 64MB of RAM. Cassandra memoryThe default auto caluclated memory configuration for DSE managed Cassandra nodes works well enough even on the PI’s, but there’s a catch. Remember those agents we need for OpsCenter? Well, turns out the agents need just enough extra memory to push things over the edge and on a system with no swap file this means page fault which is exactly what happened. I tried to quash every little process I could to free up enough RAM for my nodes to remain stable and I even made them headless, but to remain stable I had to explicitly configure the HEAP settings for my Cassandra nodes. The end result is listed up above. HeadlessSo, before I went headless things were working…uhh…well enough. Not well enough that I could leave it alone really and any time the system was put under stress !BAM! I would lose a node. This ended up being the clincher. I noticed the Raspbian UI itself was eating up just enough RAM to prevent my nodes from allocating more in times of need. I chopped off their heads and since then along with the other changes I made my nodes have been rock solid on the memory front. Memory is good how about disk?We already talked about the swap file. Not only is it strongly recommended to disable swap on nodes running Cassandra, but even more so on PI’s running on microSD’s. Before I did so it was clear my nodes were struggling as even small tasks kept driving load up and upon some inspection it was obvious I/O was mostly to blame. However, something else was lurking even after I disabled swap. At times I would see my nodes shoot up from a load of &lt;1 upwards to 10+. At this point they would usually become unresponsive and either crash or eventually come back to reality, but always, always under heavy load. Colllleccccctionnnnnn DaaaaatttttaaaaaSorry, couldn’t help myself. As stated above move collection data storage off the PI’s onto a separate cluster. They simply cannot handle all of the I/O associated with collecting, storing, and repairing the collection data from the rollup* tables. Compaction was happening way too fast for the nodes to keep up most likely a result of having very little memory to work with, the PI’s could not keep up with the amount of collection data itself, and read repair on the rollup* tables was a constant, never ending stream of repair. Once I made the switch my PI nodes all quieted down to a normal load around 1, things have stabilized, and I no longer have gaps in my analytics data (except for when I HULK SMASH nodes myself for fun). Finally, the mixed workload partYup, right there in the title and all and I haven’t really mentioned it. Part of the reason I went and did all of this aside from learning and seeing what could be done was to extend Luke Tillman’s *cough*….shame…less..plug *cooouugh* freaking awesome KillrVideo reference app to hook up to clusters outside of its Dockerized container. This forced me to extend my existing Cassandra cluster into a mixed workload scenario with DSE Search. Right, I could have simply put search within the same cluster, but I was looking to emulate what I would do in a production scenario. I have an upcoming post on this very topic coming here in the future. I also had need to extend into DSE graph as well for some of my own projects so I took the opportunity to go ahead and just do it all. The end result is a fully functional Cassandra/Search/Graph DSE managed mixed workload cluster being served up mostly on Raspberry PI’s with a little help from a laptop all hooked up to KillrVideo. One last thing before I go. I find that tailing the agent.log, opscenterd.log, and system.log files from all of the nodes is quite insightful especially when watching the interaction between the nodes when performing regular CQL, search, and graph queries. I’m also the type of person who can watch a defrag for hours and find every little box color change useful information. Not sure what that says about me.","categories":[{"name":"Technical","slug":"Technical","permalink":"https://sonicdmg.github.io/categories/Technical/"}],"tags":[{"name":"killrvideo","slug":"killrvideo","permalink":"https://sonicdmg.github.io/tags/killrvideo/"},{"name":"raspberry PI","slug":"raspberry-PI","permalink":"https://sonicdmg.github.io/tags/raspberry-PI/"},{"name":"cluster","slug":"cluster","permalink":"https://sonicdmg.github.io/tags/cluster/"}]},{"title":"I'm Sure You Weren't Looking","slug":"I-m-Sure-You-Weren-t-Looking","date":"2017-02-07T18:51:11.000Z","updated":"2017-02-07T21:56:00.000Z","comments":true,"path":"2017/02/07/I-m-Sure-You-Weren-t-Looking/","link":"","permalink":"https://sonicdmg.github.io/2017/02/07/I-m-Sure-You-Weren-t-Looking/","excerpt":"","text":"Hi there and welcome to my blog. As the title suggests I am pretty sure you had no idea this blog or page even existed. This is most likely due to the fact that I had not published anything until….just now. Wow, you are like…. THE FIRST PERSON HERE OMG! Seriously though, thanks for taking a look and make sure to come back and check out my other posts as I muse on things ranging from mishaps while up on silks to technical discussions on distributed database clusters. In my next post, I’m going to bring you through my experience setting up a Raspberry PI mixed-worlkload cluster using Cassandra. See ya :)","categories":[{"name":"Something Else","slug":"Something-Else","permalink":"https://sonicdmg.github.io/categories/Something-Else/"}],"tags":[{"name":"hi there","slug":"hi-there","permalink":"https://sonicdmg.github.io/tags/hi-there/"},{"name":"welcome","slug":"welcome","permalink":"https://sonicdmg.github.io/tags/welcome/"},{"name":"fun times","slug":"fun-times","permalink":"https://sonicdmg.github.io/tags/fun-times/"},{"name":"OMG","slug":"OMG","permalink":"https://sonicdmg.github.io/tags/OMG/"}]}]}